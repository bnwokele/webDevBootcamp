<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="style.css">
  <link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
  integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
  integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
  crossorigin=""
></script>
</head>
<body>
  <div class = "wrapper">
    <div class = "container">
      <div class = "header">
        <h1>Accident Incident Tracker</h1>
        </div>
      <div class = "menu">
        <ul>
          <li class = "menubar"><a href="index.html">Home</a></li>
          <li class = "menubar"><a href="about.html">About</a></li>
          <li class = "menubar"><a href="crimeIncident.html">Crime Incident</a></li>
        </ul>
      </div>
      <div class = "location"></div>
      <div class = "content">
        <div class = "search bar"></div>
      </div>
    </div>
  </div>
  <script>
    let content = document.querySelector(".content");
    content.setAttribute("id", "mapid");

    let map = L.map("mapid").setView([38.9935762, -76.9452331], 13);

    L.tileLayer(
      "https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiYm53b2tlbGUiLCJhIjoiY2s4azA0ODE4MG1wMzNnbXZ2ZW50MGdvbiJ9.AySpMhZu2bKPza678B_BGA",
      {
        attribution:
          'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors,' +
          '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
          'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: "mapbox/streets-v11",
        tileSize: 512,
        zoomOffset: -1,
        accessToken:
          "pk.eyJ1IjoiYm53b2tlbGUiLCJhIjoiY2s4azA0ODE4MG1wMzNnbXZ2ZW50MGdvbiJ9.AySpMhZu2bKPza678B_BGA"
      }
    ).addTo(map);

    let marker = L.marker([38.9935762, -76.9452331]).addTo(map);
    marker.bindPopup("<strong>Eppley Recreation Center</strong>").openPopup();
    
    // add lat/lon with accident incidents to the map
    fetch('/api')
      .then((data) => data.json())
      .then((data) => {
        //console.log(data) 
        let newArray1 = [];
        for(let i= 0; i < data.length; i++) {
          if(data[i].clearance_code_inc_type == "ACCIDENT")
            newArray1.push(data[i].location)
          } 
          console.log(newArray1); 
          for (let i = 0; i < newArray1.length; i++) {
            let lon = newArray1[i].latitude;
            let lat = newArray1[i].longitude;

            
            //L.marker([lat, lon]).addTo(map);
          }
        })




  const zipCodeURL = 'https://data.princegeorgescountymd.gov/resource/rv3k-ecwy.json'; // Enter the URL for the data you would like to retrieve here
  const crimeDateURL = 'https://data.princegeorgescountymd.gov/resource/wb4e-w4nf.json'
    let code = []
  // zipcode collector
    let zipcode = {};
    fetch(zipCodeURL)
    .then((data) => data.json())
    .then((data) => { 
      for(let i= 0;  i<data.length;i++){
        zipcode[data[i].zip_code]=[];
      }
      // console.log(zipcode)
      return data;
    })

    //data point zipcode adder
    //let code = [];
    fetch(crimeDateURL)
    .then((data) => data.json())
    .then((data) => { 
      for(let i= 0; i<=data.length;i++) {
        if(data[i].clearance_code_inc_type == "ACCIDENT"){
          let latitude = data[i].latitude; // get the lat and long of the accident incident
          let long= data[i].longitude 
          // api to change lat and long to zipcode
          let url ="http://api.geonames.org/findNearbyPostalCodesJSON?lat="+latitude+"&lng="+long+"&username=tyleigh";
          fetch(url)//make call to the zipcode api
            .then((rep) => rep.json())
            .then((rep) => {
              let arr= JSON.stringify(rep).split(" ");
              let start=arr[1].search("postalCode");
              zip= parseInt(arr[1].substring(start+13,start+18));
              // zipcode[zip] = zipcode[zip].push([latitude, long]);// gives the zipcode
              zipcode.zip.push([latitude, long]);// gives the zipcode
            })
        }
      }
      return zipcode;   
    })
      .then((data) => {
        console.log(data)
        res.send({zipcode}); // here's where we return data to the front end
      })
      .catch((err) => {
        console.log(err);
        res.redirect('/error');
      });

  </script>
</body>
</html>
